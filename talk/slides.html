<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html;charset=UTF-8" http-equiv="content-type">
<title>deck.rb presentation</title>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<meta content="width=1024, user-scalable=no" name="viewport">
<link href="deck.js/core/deck.core.css" rel="stylesheet">
<link href="deck.js/extensions/goto/deck.goto.css" rel="stylesheet">
<link href="deck.js/extensions/menu/deck.menu.css" rel="stylesheet">
<link href="deck.js/extensions/navigation/deck.navigation.css" rel="stylesheet">
<link href="deck.js/extensions/status/deck.status.css" rel="stylesheet">
<link href="deck.js/extensions/hash/deck.hash.css" rel="stylesheet">
<link href="deck.js/extensions/scale/deck.scale.css" rel="stylesheet">
<link href="deck.js/themes/style/swiss.css" id="style-theme-link" rel="stylesheet">
<link href="deck.js/themes/transition/horizontal-slide.css" id="transition-theme-link" rel="stylesheet">
<link href="pygments.css" rel="stylesheet">
<link href="tables.css" rel="stylesheet">
<link href="toc.css" rel="stylesheet">
</head>
<body class="deck-container">
    <section class="slide" id="asynchronous_programming_in_ios"><h2>Asynchronous Programming in iOS</h2>

<p>Paul A. Jungwirth</p>

<p>Illuminated Computing</p>

<p>PDX iOS</p>

<p>March 2014</p>

<p><a href="https://github.com/pjungwir/ios-async-talk-xcode">https://github.com/pjungwir/ios-async-talk-xcode</a></p>

</section><section class="slide" id="restaurant_review_app"><h2>Restaurant Review App</h2>

<ul>
<li>Pulls a list of restaurants from our server.</li>
<li>Runs at app startup, then once an hour.</li>
<li>The HTTP request via NSURLConnection is asynchronous.</li>
<li>The hourly requests start from an NSTimer.</li>
</ul>
<p><img src="bread.jpg" alt="bread"></p>

<p><a href="https://github.com/pjungwir/ios-async-talk-xcode">https://github.com/pjungwir/ios-async-talk-xcode</a></p>

</section><section class="slide" id="with_just_one_thread"><h2>With just one thread</h2>

<ul>
<li>Your app has a "run loop".</li>
<li>Mostly your app is just sitting there.</li>
<li>Event callbacks happen on the main loop.</li>
<li>Everything is one thread, unless you do something special.</li>
</ul></section><section class="slide" id="threading_primitives"><h2>Threading primitives</h2>

<p><img src="herding-cats.jpg" alt="Herding cats"></p>

<ul>
<li>atomic operators</li>
<li>pthread mutexes</li>
<li>NSLock</li>
<li>@synchronized(obj) { }</li>
<li>NSRecursiveLock, NSConditionLock, NSDistributedLock</li>
<li>NSCondition</li>
</ul></section><section class="slide" id="deadlock"><h2>Deadlock</h2>

<p><img src="deadlock.png" alt="Thread deadlock"></p>

<p>Options:</p>

<ul>
<li>Always take locks in the same order.</li>
<li>Take one big lock.</li>
<li>Don't use locks.</li>
</ul></section><section class="slide" id="higherlevel_alternatives"><h2>Higher-Level Alternatives</h2>

<ul>
<li>GCD: dispatch_async</li>
<li>NSOperation, NSOperationQueue</li>
</ul>
<p><img src="async-abstractions.png" alt="Async abstractions"></p>

</section><section class="slide" id="rules"><h2>Rules</h2>

<ul>
<li>UI updates must happen on the main run loop.</li>
<li>Must synchronize read/writes to shared data.</li>
<li>. . . or keep all reads/writes on one thread!</li>
</ul></section><section class="slide" id="our_restaurant_app"><h2>Our Restaurant App</h2>

<div class="highlight"><pre><span class="c1">// branch: master</span>

<span class="k">@implementation</span> <span class="nc">MyAppDelegate</span> <span class="p">{</span>
  <span class="n">NSArray</span> <span class="o">*</span><span class="n">_restaurants</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span> <span class="nl">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span>
  <span class="nl">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">launchOptions</span> <span class="p">{</span>
  <span class="p">[</span><span class="n">self</span> <span class="n">fetchRestaurants</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// . . .</span>

<span class="k">@end</span>
</pre></div>


</section><section class="slide" id="with_a_timer"><h2>With a timer</h2>

<div class="highlight"><pre><span class="c1">// branch: master</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span> <span class="nl">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span>
  <span class="nl">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">launchOptions</span> <span class="p">{</span>
  <span class="p">[</span><span class="n">self</span> <span class="n">fetchRestaurants</span><span class="p">];</span>

  <span class="p">[</span><span class="n">NSTimer</span> <span class="nl">scheduledTimerWithTimeInterval:</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
                                   <span class="nl">target:</span><span class="n">self</span>
                                 <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">fetchRestaurants</span><span class="p">)</span>
                                 <span class="nl">userInfo:</span><span class="nb">nil</span>
                                  <span class="nl">repeats:</span><span class="n">YES</span><span class="p">];</span>
  <span class="c1">// . . .</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="sync_http_request"><h2>Sync HTTP Request</h2>

<div class="highlight"><pre><span class="c1">// branch: sync</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">fetchRestaurants</span> <span class="p">{</span>
  <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">kAPIRestaurantsURL</span><span class="p">];</span>
  <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
  <span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
  <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
  <span class="n">NSData</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLConnection</span> <span class="nl">sendSynchronousRequest:</span><span class="n">req</span>
                                  <span class="nl">returningResponse:</span><span class="o">&amp;</span><span class="n">resp</span>
                                              <span class="nl">error:</span><span class="o">&amp;</span><span class="n">err</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">_restaurants</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyRestaurant</span> <span class="nl">parseJSON:</span><span class="n">d</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><img src="beach-ball.jpg" alt="Mac beach ball"></p>

</section><section class="slide" id="async_http_request"><h2>Async HTTP Request</h2>

<div class="highlight"><pre><span class="c1">// branch: async-notification</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">fetchRestaurants</span> <span class="p">{</span>
  <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">kAPIRestaurantsURL</span><span class="p">];</span>
  <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
  <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">];</span>
  <span class="p">[</span><span class="n">NSURLConnection</span> <span class="nl">sendAsynchronousRequest:</span><span class="n">req</span>
                                       <span class="nl">queue:</span><span class="n">q</span>
                             <span class="nl">completionHandler:</span>
    <span class="o">^</span><span class="p">(</span><span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">NSData</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">_restaurants</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyRestaurant</span> <span class="nl">parseJSON:</span><span class="n">d</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}];</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="parsing_the_json"><h2>Parsing the JSON</h2>

<div class="highlight"><pre><span class="c1">// branch: async-notification</span>

<span class="k">@implementation</span> <span class="nc">MyRestaurant</span> <span class="p">{</span>
<span class="o">+</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span> <span class="nl">parseJSON:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span> <span class="p">{</span>
  <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">restaurants</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="n">new</span><span class="p">];</span>
  <span class="n">NSError</span> <span class="o">*</span><span class="n">jsonError</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
  <span class="n">NSArray</span> <span class="o">*</span><span class="n">restFile</span> <span class="o">=</span>
    <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData:</span><span class="n">d</span>
                                    <span class="nl">options:</span><span class="mi">0</span>
                                      <span class="nl">error:</span><span class="o">&amp;</span><span class="n">jsonError</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dict</span> <span class="k">in</span> <span class="n">restFile</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MyRestaurant</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MyRestaurant</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithDictionary:</span><span class="n">dict</span><span class="p">];</span>
    <span class="p">[</span><span class="n">restaurants</span> <span class="nl">addObject:</span><span class="n">r</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">restaurants</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="async_parsing_with_nsoperation"><h2>Async parsing with NSOperation</h2>

<ul>
<li>define an operation to do the parsing</li>
<li>add it to the queue</li>
<li>post a notification when done</li>
</ul>
<div class="highlight"><pre><span class="c1">// branch: async-notification</span>

<span class="k">@implementation</span> <span class="nc">MyParseRestaurantsOperation</span> <span class="p">{</span>
    <span class="n">NSData</span> <span class="o">*</span><span class="n">_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nl">initWithData:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">_data</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">main</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">restaurants</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyRestaurant</span> <span class="nl">parseJSON:</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">_data</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span>
      <span class="nl">postNotificationName:</span><span class="s">@"ParseRestaurantsOperationFinished"</span>
                                                   <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</pre></div>


</section><section class="slide" id="async_parsing_with_nsoperationqueue"><h2>Async parsing with NSOperationQueue</h2>

<div class="highlight"><pre><span class="c1">// MyAppDelegate.m:</span>
<span class="c1">// branch: async-notification</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">fetchRestaurants</span> <span class="p">{</span>
    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">kAPIRestaurantsURL</span><span class="p">];</span>
    <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
    <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">];</span>
    <span class="p">[</span><span class="n">NSURLConnection</span> <span class="nl">sendAsynchronousRequest:</span><span class="n">req</span>
                                       <span class="nl">queue:</span><span class="n">q</span>
                           <span class="nl">completionHandler:</span>
     <span class="o">^</span><span class="p">(</span><span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">NSData</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">MyParseRestaurantsOperation</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span>
               <span class="p">[[</span><span class="n">MyParseRestaurantsOperation</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData:</span><span class="n">d</span><span class="p">];</span>
             <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">addObserver:</span><span class="n">self</span>
                             <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">parsedRestaurants:</span><span class="p">)</span>
                          <span class="nl">name:</span><span class="s">@"ParseRestaurantsOperationFinished"</span>
                                                         <span class="nl">object:</span><span class="n">op</span><span class="p">];</span>
             <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">background</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">new</span><span class="p">];</span>
             <span class="p">[</span><span class="n">background</span> <span class="nl">addOperation:</span><span class="n">op</span><span class="p">];</span>
         <span class="p">}</span>
     <span class="p">}];</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="getting_an_nsnotification_from_our_queue"><h2>Getting an NSNotification from our queue.</h2>

<div class="highlight"><pre><span class="c1">// MyAppDelegate.m:</span>
<span class="c1">// branch: async-notification</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">parsedRestaurants:</span><span class="p">(</span><span class="n">NSNotification</span> <span class="o">*</span><span class="p">)</span><span class="n">n</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nl">performSelectorOnMainThread:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">updateRestaurants:</span><span class="p">)</span>
      <span class="nl">withObject:</span><span class="p">((</span><span class="n">MyParseRestaurantsOperation</span><span class="o">*</span><span class="p">)[</span><span class="n">n</span> <span class="n">object</span><span class="p">]).</span><span class="n">restaurants</span>
                                                      <span class="nl">waitUntilDone:</span><span class="n">NO</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">updateRestaurants:</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="n">restaurants</span> <span class="p">{</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">_restaurants</span> <span class="o">=</span> <span class="n">restaurants</span><span class="p">;</span>
    <span class="p">[((</span><span class="n">MyViewController</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">rootViewController</span><span class="p">).</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="setcompletionblock_to_avoid_notifications"><h2>setCompletionBlock to avoid notifications</h2>

<div class="highlight"><pre><span class="c1">// MyAppDelegate.m:</span>
<span class="c1">// branch: async-completion-block</span>

  <span class="n">MyParseRestaurantsOperation</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span>
    <span class="p">[[</span><span class="n">MyParseRestaurantsOperation</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData:</span><span class="n">d</span><span class="p">];</span>
  <span class="p">[</span><span class="n">op</span> <span class="nl">setCompletionBlock:</span><span class="o">^</span><span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nl">performSelectorOnMainThread:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">updateRestaurants:</span><span class="p">)</span>
                                          <span class="nl">withObject:</span><span class="n">op</span><span class="p">.</span><span class="n">restaurants</span>
                                                  <span class="nl">waitUntilDone:</span><span class="n">NO</span><span class="p">];</span>
  <span class="p">}];</span>
  <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">background</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">new</span><span class="p">];</span>
  <span class="p">[</span><span class="n">background</span> <span class="nl">addOperation:</span><span class="n">op</span><span class="p">];</span>
</pre></div>


</section><section class="slide" id="retain_cycles"><h2>Retain Cycles</h2>

<p><img src="retain-cycle.png" alt="Retain Cycle"></p>

</section><section class="slide" id="blocks_and_retain_cycles"><h2>Blocks and retain cycles</h2>

<p><a href="https://developer.apple.com/videos/wwdc/2011/">https://developer.apple.com/videos/wwdc/2011/</a></p>

<ul>
<li>WWDC 2011: Blocks and Grand Central Dispatch in Practice</li>
<li>WWDC 2011: Objective-C Advancements in Depth</li>
</ul>
<p>If a block is <em>copied</em>, then it retains whatever it closed over.</p>

<p>If you are in turn retaining the block (perhaps indirectly), you have a retain cycle.</p>

<p>Usually it's a problem with <code>self</code>.</p>

<p>Watch out closing over _ivars! (<code>self-&gt;_op</code>)</p>

</section><section class="slide" id="setcompletionblock_copies_the_block"><h2>setCompletionBlock copies the block</h2>

<p><img src="setCompletionBlock.png" alt="setCompletionBlock docs"></p>

</section><section class="slide" id="setcompletionblock_without_memory_leak_weakstrong_dance"><h2>setCompletionBlock without memory leak: "weak-strong dance"</h2>

<ul>
<li>Close over a weak reference.</li>
<li>Give the block its own strong reference.</li>
<li>Make sure the instance didn't disappear in the meantime.</li>
</ul>
<div class="highlight"><pre><span class="c1">// MyAppDelegate.m:</span>
<span class="c1">// branch: async-completion-block</span>

  <span class="n">MyParseRestaurantsOperation</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span>
    <span class="p">[[</span><span class="n">MyParseRestaurantsOperation</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData:</span><span class="n">d</span><span class="p">];</span>
  <span class="n">__weak</span> <span class="n">MyParseRestaurantsOperation</span> <span class="o">*</span><span class="n">weakOp</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="p">[</span><span class="n">d</span> <span class="nl">setCompletionBlock:</span><span class="o">^</span><span class="p">{</span>
    <span class="n">MyParseRestaurantsOperation</span> <span class="o">*</span><span class="n">strongOp</span> <span class="o">=</span> <span class="n">weakOp</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strongOp</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nl">performSelectorOnMainThread:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">updateRestaurants:</span><span class="p">)</span>
                                    <span class="nl">withObject:</span><span class="n">strongOp</span><span class="p">.</span><span class="n">restaurants</span>
                                                  <span class="nl">waitUntilDone:</span><span class="n">NO</span><span class="p">];</span>
  <span class="p">}];</span>
  <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">background</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">new</span><span class="p">];</span>
  <span class="p">[</span><span class="n">background</span> <span class="nl">addOperation:</span><span class="n">op</span><span class="p">];</span>
</pre></div>


</section><section class="slide" id="block_as_nsoperation"><h2>Block as NSOperation</h2>

<div class="highlight"><pre><span class="c1">// MyAppDelegate.m:</span>
<span class="c1">// branch: async-block-as-nsoperation</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">fetchRestaurants</span> <span class="p">{</span>
    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">kAPIRestaurantsURL</span><span class="p">];</span>
    <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
    <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">];</span>
    <span class="p">[</span><span class="n">NSURLConnection</span> <span class="nl">sendAsynchronousRequest:</span><span class="n">req</span>
                                       <span class="nl">queue:</span><span class="n">q</span>
                           <span class="nl">completionHandler:</span>
     <span class="o">^</span><span class="p">(</span><span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">NSData</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">background</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">new</span><span class="p">];</span>
             <span class="p">[</span><span class="n">background</span> <span class="nl">addOperationWithBlock:</span><span class="o">^</span><span class="p">{</span>
                 <span class="n">NSArray</span> <span class="o">*</span><span class="n">restaurants</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyRestaurant</span> <span class="nl">parseJSON:</span><span class="n">d</span><span class="p">];</span>
                 <span class="p">[</span><span class="n">self</span> <span class="nl">performSelectorOnMainThread:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">updateRestaurants:</span><span class="p">)</span>
                                                          <span class="nl">withObject:</span><span class="n">restaurants</span>
                                                               <span class="nl">waitUntilDone:</span><span class="n">NO</span><span class="p">];</span>
             <span class="p">}];</span>
         <span class="p">}</span>
     <span class="p">}];</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="do_the_nsurlconnection_callback_on_a_different_queue"><h2>Do the NSURLConnection callback on a different queue</h2>

<div class="highlight"><pre><span class="c1">// MyAppDelegate.m:</span>
<span class="c1">// branch: async-urlconnection-callback-different-queue</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">fetchRestaurants</span> <span class="p">{</span>
    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">kAPIRestaurantsURL</span><span class="p">];</span>
    <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
    <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">new</span><span class="p">];</span>
    <span class="p">[</span><span class="n">NSURLConnection</span> <span class="nl">sendAsynchronousRequest:</span><span class="n">req</span>
                                       <span class="nl">queue:</span><span class="n">q</span>
                           <span class="nl">completionHandler:</span>
     <span class="o">^</span><span class="p">(</span><span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">NSData</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">NSArray</span> <span class="o">*</span><span class="n">restaurants</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyRestaurant</span> <span class="nl">parseJSON:</span><span class="n">d</span><span class="p">];</span>
             <span class="p">[</span><span class="n">self</span> <span class="nl">performSelectorOnMainThread:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">updateRestaurants:</span><span class="p">)</span>
                                                      <span class="nl">withObject:</span><span class="n">restaurants</span>
                                                           <span class="nl">waitUntilDone:</span><span class="n">NO</span><span class="p">];</span>
         <span class="p">}</span>
     <span class="p">}];</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="async_parsing_with_gcd"><h2>Async parsing with GCD</h2>

<p>Set up a dispatch_queue with GCD:</p>

<div class="highlight"><pre><span class="c1">// branch: async-gcd</span>

<span class="k">@implementation</span> <span class="nc">MyAppDelegate</span> <span class="p">{</span>
  <span class="n">NSArray</span> <span class="o">*</span><span class="n">_restaurants</span><span class="p">;</span>
  <span class="n">dispatch_queue_t</span> <span class="n">_restaurants_queue</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nl">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span>
  <span class="nl">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">launchOptions</span> <span class="p">{</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">_restaurants_queue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">"com.example.restaurants"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="p">[</span><span class="n">self</span> <span class="n">fetchRestaurants</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="async_parsing_with_gcd"><h2>Async parsing with GCD</h2>

<p>Do our parsing on our own queue:</p>

<div class="highlight"><pre><span class="c1">// branch: async-gcd</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">fetchRestaurants</span> <span class="p">{</span>
  <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">kAPIRestaurantsURL</span><span class="p">];</span>
  <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
  <span class="n">NSOperationQueue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">];</span>
  <span class="p">[</span><span class="n">NSURLConnection</span> <span class="nl">sendAsynchronousRequest:</span><span class="n">req</span>
                                     <span class="nl">queue:</span><span class="n">q</span>
                         <span class="nl">completionHandler:</span>
    <span class="o">^</span><span class="p">(</span><span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">NSData</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dispatch_async</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">_restaurants_queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
          <span class="n">NSArray</span> <span class="o">*</span><span class="n">restaurants</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyRestaurant</span> <span class="nl">parseJSON:</span><span class="n">d</span><span class="p">];</span>
          <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
            <span class="n">self</span><span class="o">-&gt;</span><span class="n">_restaurants</span> <span class="o">=</span> <span class="n">restaurants</span><span class="p">;</span>
            <span class="p">[((</span><span class="n">MyViewController</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">rootViewController</span><span class="p">).</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}];</span>
<span class="p">}</span>
</pre></div>


</section><section class="slide" id="references_and_further_reading"><h2>References and Further Reading</h2>

<ul>
<li><a href="https://developer.apple.com/videos/wwdc/2011/">https://developer.apple.com/videos/wwdc/2011/</a></li>
<li><a href="http://www.raywenderlich.com/4295/multithreading-and-grand-central-dispatch-on-ios-for-beginners-tutorial">http://www.raywenderlich.com/4295/multithreading-and-grand-central-dispatch-on-ios-for-beginners-tutorial</a></li>
<li><a href="http://www.raywenderlich.com/19788/how-to-use-nsoperations-and-nsoperationqueues">http://www.raywenderlich.com/19788/how-to-use-nsoperations-and-nsoperationqueues</a></li>
<li><a href="http://www.amazon.com/Programming-iOS-7-Matt-Neuburg/dp/1449372341">http://www.amazon.com/Programming-iOS-7-Matt-Neuburg/dp/1449372341</a></li>
<li><a href="http://www.amazon.com/Java-Threads-Scott-Oaks/dp/0596007825">http://www.amazon.com/Java-Threads-Scott-Oaks/dp/0596007825</a></li>
<li><a href="https://github.com/pjungwir/ios-async-talk">https://github.com/pjungwir/ios-async-talk</a></li>
<li><a href="https://github.com/pjungwir/ios-async-talk-xcode">https://github.com/pjungwir/ios-async-talk-xcode</a></li>
</ul></section><section class="slide" id="thanks"><h2>Thanks!</h2>

<p>Paul Jungwirth</p>

<p><a href="mailto:pj@illuminatedcomputing.com">pj@illuminatedcomputing.com</a></p>

</section><a class="deck-prev-link" href="#" title="Previous"></a><a class="deck-next-link" href="#" title="Next"></a>    <div class="slide_toc">      <div class="toggle">[contents]</div>
      <div class="table">
        <h2>deck.rb presentation</h2>
        <ul>
<li><a href="#asynchronous_programming_in_ios">Asynchronous Programming in iOS</a></li>
          <li><a href="#restaurant_review_app">Restaurant Review App</a></li>
          <li><a href="#with_just_one_thread">With just one thread</a></li>
          <li><a href="#threading_primitives">Threading primitives</a></li>
          <li><a href="#deadlock">Deadlock</a></li>
          <li><a href="#higherlevel_alternatives">Higher-Level Alternatives</a></li>
          <li><a href="#rules">Rules</a></li>
          <li><a href="#our_restaurant_app">Our Restaurant App</a></li>
          <li><a href="#with_a_timer">With a timer</a></li>
          <li><a href="#sync_http_request">Sync HTTP Request</a></li>
          <li><a href="#async_http_request">Async HTTP Request</a></li>
          <li><a href="#parsing_the_json">Parsing the JSON</a></li>
          <li><a href="#async_parsing_with_nsoperation">Async parsing with NSOperation</a></li>
          <li><a href="#async_parsing_with_nsoperationqueue">Async parsing with NSOperationQueue</a></li>
          <li><a href="#getting_an_nsnotification_from_our_queue">Getting an NSNotification from our queue.</a></li>
          <li><a href="#setcompletionblock_to_avoid_notifications">setCompletionBlock to avoid notifications</a></li>
          <li><a href="#retain_cycles">Retain Cycles</a></li>
          <li><a href="#blocks_and_retain_cycles">Blocks and retain cycles</a></li>
          <li><a href="#setcompletionblock_copies_the_block">setCompletionBlock copies the block</a></li>
          <li><a href="#setcompletionblock_without_memory_leak_weakstrong_dance">setCompletionBlock without memory leak: "weak-strong dance"</a></li>
          <li><a href="#block_as_nsoperation">Block as NSOperation</a></li>
          <li><a href="#do_the_nsurlconnection_callback_on_a_different_queue">Do the NSURLConnection callback on a different queue</a></li>
          <li><a href="#async_parsing_with_gcd">Async parsing with GCD</a></li>
          <li><a href="#async_parsing_with_gcd">Async parsing with GCD</a></li>
          <li><a href="#references_and_further_reading">References and Further Reading</a></li>
          <li><a href="#thanks">Thanks!</a></li>
        </ul>
</div>
    </div>
    <p class="deck-status"><span class="deck-status-current"></span>/<span class="deck-status-total"></span></p>
    <form action="." class="goto-form" method="get">
      <label for="goto-slide">Go to slide:</label>
      <input id="goto-slide" list="goto-datalist" name="slidenum" type="text"><datalist id="goto-datalist"></datalist><input type="submit" value="Go">
</form>
    <a class="deck-permalink" href="." title="Permalink to this slide">#</a>
    <script src="deck.js/modernizr.custom.js"></script><script src="deck.js/jquery-1.7.2.min.js"></script><script type="text/javascript">
// <![CDATA[

jQuery(document).ready(function($){
    $('.slide_toc .toggle').click(function(){
      $('.slide_toc .table').toggle();
    });

});
// ]]>
    </script><!--Deck Core and extensions--><script src="deck.js/core/deck.core.js" type="text/javascript"></script><script src="deck.js/extensions/goto/deck.goto.js" type="text/javascript"></script><script src="deck.js/extensions/menu/deck.menu.js" type="text/javascript"></script><script src="deck.js/extensions/navigation/deck.navigation.js" type="text/javascript"></script><script src="deck.js/extensions/status/deck.status.js" type="text/javascript"></script><script src="deck.js/extensions/hash/deck.hash.js" type="text/javascript"></script><script src="deck.js/extensions/scale/deck.scale.js" type="text/javascript"></script><script>$(function(){$.deck('.slide');});</script>
</body>
</html>
